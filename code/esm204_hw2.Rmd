---
title: "ESM 204 HW2"
author: "Patrick Pelegri-O'Day"
date: "4/14/2022"
output: html_document
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(here)
library(tidyverse)
library(janitor)
library(broom)
```

```{r}
# Read in data
water_raw <- read_csv(here('data', 'Water_Districts.csv'))

water <- water_raw %>% clean_names()
```

```{r}
# No longer using this approach. Making the df longer allowed the curves' x-intercepts to be visible on the graph, but I'm no longer trying to do that because the wrangling is more complicated when the df is pivoted longer

# # Make the data frame longer and extend water$reduction
# empty_df <- data.frame(matrix(ncol = 6, nrow = 115))
# colnames(empty_df) <- c('x1', 'reduction', 'mc_kern', 'mc_mojave', 'mc_antelope', 'mc_ventura')
# water <- rbind(water, empty_df)
# water$reduction <- seq(0, 255, by = 1)
```

```{r}
# Pivot data frame longer to make district a variable
water <- water %>% 
  rename(kern = mc_kern,
         mojave = mc_mojave,
         antelope = mc_antelope,
         ventura = mc_ventura) %>% 
  pivot_longer(!(x1:reduction), names_to = 'district', values_to = 'mc')
```

```{r}
# Define linear regression models
water_kern <- water %>% filter(district == 'kern')
kern_lm <- lm(mc ~ 0 + reduction, data = water_kern)

water_mojave <- water %>% filter(district == 'mojave')
mojave_lm <- lm(mc ~ 0 + reduction, data = water_mojave)

water_antelope <- water %>% filter(district == 'antelope')
antelope_lm <- lm(mc ~ 0 + reduction, data = water_antelope)

water_ventura <- water %>% filter(district == 'ventura')
ventura_lm <- lm(mc ~ 0 + reduction, data = water_ventura)
```

```{r}
# Find slopes
kern_slope <- kern_lm$coefficient[1]
mojave_slope <- mojave_lm$coefficient[1]
antelope_slope <- antelope_lm$coefficient[1]
ventura_slope <- ventura_lm$coefficient[1]
```

```{r}
# Make df of slopes and add to main df
kern_slope_v <- c(rep(kern_slope, 141))
mojave_slope_v <- c(rep(kern_slope, 141))
antelope_slope_v <- c(rep(kern_slope, 141))
ventura_slope_v <- c(rep(kern_slope, 141))

slope_df <- data.frame(kern_slope_v, 
                       mojave_slope_v,
                       antelope_slope_v,
                       ventura_slope_v) %>% 
  rename(kern = kern_slope_v,
         mojave = mojave_slope_v,
         antelope = antelope_slope_v,
         ventura = ventura_slope_v) %>% 
  pivot_longer(kern:ventura,
               names_to = 'district',
               values_to = 'slope')

slope_df <- slope_df %>% 
  mutate(case_when(
    district = 'kern' ~ baseline = 150
  ))

water$slope <- slope_df$slope
```


```{r}
# Create predicted MC curves
kern_predict <- predict(kern_lm)
mojave_predict <- predict(mojave_lm)
antelope_predict <- predict(antelope_lm)
ventura_predict <- predict(ventura_lm)
```

```{r}
# Turn predicted MC curves into a data frame
mc_predict_df <- data.frame(kern_predict, mojave_predict, antelope_predict, ventura_predict) %>% 
  rename(kern = kern_predict,
         mojave = mojave_predict,
         antelope = antelope_predict,
         ventura = ventura_predict) %>% 
  pivot_longer(kern:ventura, names_to = 'district', values_to = 'mc_predict')

# Add predicted MC curves to our water data frame
water$mc_predict <- mc_predict_df$mc_predict
```

```{r}
# This is old code from before I pivoted longer

# # Create vector of predicted MCs for each district
# water$mc_predict <- water$reduction * kern_slope
# water$mc_mojave_predict <- water$reduction * mojave_slope
# water$mc_antelope_predict <- water$reduction * antelope_slope
# water$mc_ventura_predict <- water$reduction * ventura_slope
```
              
```{r}
# Demand curve
water <- water %>% 
  mutate(demand = slope*(baseline - reduction))

# Create demand column for each district
water$kern_demand <- kern_slope*(150 - water$reduction)
water$mojave_demand <- mojave_slope*(140 - water$reduction)
water$antelope_demand <- antelope_slope*(220 - water$reduction)
water$ventura_demand <- ventura_slope*(245 - water$reduction)
```

```{r}
# Plot MC curves
ggplot(data = water, aes(x = reduction, y = mc_predict, color = district)) +
  geom_line()
```


```{r}
# Plot demand curves
ggplot(data = water, aes(x = reduction)) +
  geom_line(aes(y = kern_demand, color = district)) +
  geom_line(aes(y = mojave_demand, color = district)) +
  geom_line(aes(y = antelope_demand, color = district)) +
  geom_line(aes(y = ventura_demand, color = district)) +
  ylim(0, NA) +
  labs(y = 'USD per acre-foot', x = 'Acre-feet used')
```

- Calculate MC curves: MC = slope (from regression) * Q
  - Get in terms of Q = 1/slope * P
  - Add up so Q = (1/slope_A + 1/slope_B) * P
  - Set that Q = to desired cap --> you get P*
  - Each firm will produce a Q where MC = P*



```{r}
# TO DO
# - Pivot water data longer so that district is a variable, then plot regressions using color = district

# Plot linear regression models
ggplot(data = water) +
  geom_line(aes(x = reduction, y = mc_kern), color = "azure3") +
  geom_smooth(aes(x = reduction, y = mc_kern), method = "lm", se = FALSE, color = "firebrick4") +
  
  geom_line(aes(x = reduction, y = mc_mojave), color = "azure3") +
  geom_smooth(aes(x = reduction, y = mc_mojave), method = "lm", se = FALSE, color = "darkolivegreen4") +
 
   geom_line(aes(x = reduction, y = mc_antelope), color = "azure3") +
  geom_smooth(aes(x = reduction, y = mc_antelope), method = "lm", se = FALSE, color = "darkslategray4") +
 
   geom_line(aes(x = reduction, y = mc_ventura), color = "azure3") +
  geom_smooth(aes(x = reduction, y = mc_ventura), method = "lm", se = FALSE, color = "goldenrod4") +
  
  theme_minimal() +
  labs(x = "\nAbatement quantity (AF)",
       y = "Marginal abatement cost (USD) \n")
```

Kern's equation is y = 3.74 + 2.29x
Kern's predicted abatement MC is 340 USD for the 150th unit of abatement
Thus, the y-intercept for Kern's demand curve for water is 340 USD, and the slope of Kern's demand curve is -2.25x. Kern's demand curve: y = 340 - 2.25x.

Using the same method, we find the following demand curves for the remaining water districts

Ventura: y = 436.67 - 1.79x (total use = 245 AF)
Mojave: y = 532.71 - 3.8x (total use = 140 AF)
Antelope: y = 629.14 - 1.78x (total use = 220 AF)

```{r}
# Find intecepts of MC abatement curves to calculate demand curves
kern_tidy <- tidy(kern_lm)
kern_tidy

antelope_tidy <- tidy(antelope_lm)
antelope_tidy

mojave_tidy <- tidy(mojave_lm)
mojave_tidy

ventura_tidy <- tidy(ventura_lm)
ventura_tidy
```

### Question 2: Demand curves

```{r}
# Define demand curves
kern_demand <- function(AF_used){
  AF_price <- AF_used*-2.25 + 340
}

ggplot(kern_demand, from = 0, to = 150)
```

Antelope's demand curve for water use has the highest y-intercept. In other words, Antelope water district is willing to pay the most out of any water district for the first AF of water use.

### Question 3: Policy interventions
a) Cap without trade
  1. x(220 + 140 + 150 + 245) = 500 --> x = 0.662
  3. find the magnitude of reduction for each county. take the integral from 0 to that reduction for each integral using that district's marginal cost abatement curve
  2. Add all these together
  4. No tax revenue generated
  
b) Tax on water use
  1. Horizontally sum your MC abatement curves
  2. Where that horizontally summed curve reaches the desired abatement curve, you will have your price
  3. Where that price level intersects each MC abatement curve, you will have the efficient abatement quantity for each district to achieve the desired total abatement level.

